steps:
  # 1. Create Artifact Registry Repo if it doesn't exist
  - name: 'gcr.io/cloud-builders/gcloud'
    id: "Setup Artifact Registry"
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud artifacts repositories describe sara-repo --location=${_REGION} || \
        gcloud artifacts repositories create sara-repo \
          --repository-format=docker \
          --location=${_REGION} \
          --description="SARA application container repository"

  # 2. Build the retrieval-service
  - name: 'gcr.io/cloud-builders/docker'
    id: "Build retrieval-service"
    args:
      - 'build'
      - '--no-cache'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/sara-repo/sara-retrieval-service:latest'
      - './src/retrieval_service'
    waitFor:
      - "Setup Artifact Registry"

  # 3. Push the retrieval-service image
  - name: 'gcr.io/cloud-builders/docker'
    id: "Push retrieval-service"
    args: ['push', '${_REGION}-docker.pkg.dev/${PROJECT_ID}/sara-repo/sara-retrieval-service:latest']
    waitFor:
      - "Build retrieval-service"

  # 4. Build the frontend-service
  - name: 'gcr.io/cloud-builders/docker'
    id: "Build frontend-service"
    args:
      - 'build'
      - '--no-cache'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/sara-repo/sara-frontend-service:latest'
      - './src/frontend_service'
    waitFor:
      - "Setup Artifact Registry"

  # 5. Push the frontend-service image
  - name: 'gcr.io/cloud-builders/docker'
    id: "Push frontend-service"
    args: ['push', '${_REGION}-docker.pkg.dev/${PROJECT_ID}/sara-repo/sara-frontend-service:latest']
    waitFor:
      - "Build frontend-service"

  # 6. Initialize Terraform
  - name: 'hashicorp/terraform:1.5.7'
    id: "Terraform init"
    entrypoint: 'terraform'
    args: ['init', '-reconfigure']

  # 7. Apply Terraform configuration
  - name: 'hashicorp/terraform:1.5.7'
    id: "Terraform apply"
    entrypoint: 'terraform'
    args:
      - 'apply'
      - '-auto-approve'
      - '-var=project_id=${PROJECT_ID}'
      - '-var=region=${_REGION}'
      - '-var=db_user=${_DB_USER}'
      - '-var=db_pass=${_DB_PASS}'
      - '-var=db_name=${_DB_NAME}'
    waitFor:
      - "Terraform init"
      - "Push retrieval-service"
      - "Push frontend-service"

  # 8. Start Cloud SQL Auth Proxy in the background
  - name: 'gcr.io/cloudsql-docker/gce-proxy:latest'
    id: 'Start DB Proxy'
    entrypoint: 'sh'
    args:
      - '-c'
      - '/cloud_sql_proxy -instances=${_DB_CONNECTION_NAME}=tcp:5432 &'
    waitFor:
      - "Terraform apply"

  # 9. Wait for the proxy to be ready
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Wait for DB Proxy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        until nc -z 127.0.0.1 5432; do
          echo "Waiting for proxy...";
          sleep 1;
        done
    waitFor:
      - 'Start DB Proxy'

  # 10. Run the simplified database migration script
  - name: 'python:3.9-slim'
    id: 'Run DB Migrations'
    entrypoint: '/bin/bash'
    args:
      - '-c'
      - |
        pip install -r src/retrieval_service/requirements.txt
        cd src/retrieval_service
        alembic upgrade head
    env:
      - 'DB_USER=${_DB_USER}'
      - 'DB_PASS=${_DB_PASS}'
      - 'DB_NAME=${_DB_NAME}'
      - 'DB_HOST=127.0.0.1'
      - 'DB_PORT=5432'
    waitFor:
      - 'Wait for DB Proxy'

  # 11. Stop the proxy cleanly
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Stop DB Proxy'
    entrypoint: 'bash'
    args:
      - '-c'
      - 'kill -s TERM $(pgrep cloud_sql_proxy)'
    waitFor:
      - 'Run DB Migrations'

# Define substitution variables
substitutions:
  _REGION: "us-central1"
  _DB_USER: "sara-user"
  _DB_PASS: "secure-password-placeholder" # This should be set securely
  _DB_NAME: "sara-db"
  _DB_CONNECTION_NAME: "" # e.g. my-project:us-central1:my-instance

# Define image outputs for other systems to